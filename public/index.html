<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="styles.css">
  <script src="/socket.io/socket.io.js"></script>
  <title>Pong Multiplayer</title>
</head>

<body>
  <main id='main'>
    <h3 id='title'>Pong Multiplayer</h3>
    <canvas id='box' width='15' height='15'></canvas>
  </main>
</body>

<script type="module">
  const canvas = document.getElementById('box');
  const ctx = canvas.getContext("2d");

  const socket = io();

  socket.on('connect', () => {
    const { id } = socket;
    console.log(`[IO] Connected to server. Player ID: ${id}`);
    socket.emit('enter_game');
  });

  socket.on('state', (state) => {
    renderState(state);
  });

  function renderState(state) {
    const { players, ball } = state;

    ctx.fillStyle = "#000";
    ctx.clearRect(0, 0, 15, 15);
    ctx.fillRect(ball.x, ball.y, 1, 1);

    for (const playerId in players) {
      const player = players[playerId];

      ctx.fillStyle = '#fff';
      ctx.fillRect(player.x, player.y, 1, -1);
      ctx.fillRect(player.x, player.y, 1, 1);
      ctx.fillRect(player.x, player.y, 1, 2);
    }
  }

  function handleKeyboard(e) {
    const { key } = e;
    if (key === 'Enter')
      socket.emit('ready');

    const direction = {"ArrowUp": "up", "ArrowDown": "down"}[key];
    if (direction) {
      socket.emit('move', { direction });
    }
  }

  document.addEventListener('keydown', handleKeyboard)
</script>
</html>